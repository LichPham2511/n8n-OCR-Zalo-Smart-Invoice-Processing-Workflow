{
  "name": "OCR-zalo",
  "nodes": [
    {
      "parameters": {
        "threadId": "={{ $json.message.threadId }}",
        "type": "={{ $json.message.type }}",
        "message": "ü§ñ **H·ªÜ TH·ªêNG X·ª¨ L√ù H√ìA ƒê∆†N TH√îNG MINH**\n\n‚ö†Ô∏è **C·∫ßn h√¨nh ·∫£nh ƒë·ªÉ x·ª≠ l√Ω**\n\nüì∏ **C√°c lo·∫°i t√†i li·ªáu ƒë∆∞·ª£c h·ªó tr·ª£:**\n‚Ä¢ H√≥a ƒë∆°n mua h√†ng (Shopee, Lazada, Tiki...)\n‚Ä¢ Phi·∫øu giao h√†ng (GHN, GHTK, ViettelPost...)\n‚Ä¢ H√≥a ƒë∆°n nh√† h√†ng/c·ª≠a h√†ng\n‚Ä¢ Bi√™n lai thanh to√°n\n‚Ä¢ X√°c nh·∫≠n chuy·ªÉn kho·∫£n\n\nüí° **H∆∞·ªõng d·∫´n:**\n1Ô∏è‚É£ Ch·ª•p ·∫£nh r√µ n√©t, ƒë·∫ßy ƒë·ªß th√¥ng tin\n2Ô∏è‚É£ ƒê·∫£m b·∫£o √°nh s√°ng t·ªët\n3Ô∏è‚É£ G·ª≠i ·∫£nh v√† h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ph√¢n t√≠ch\n\nüöÄ **G·ª≠i ·∫£nh ngay ƒë·ªÉ b·∫Øt ƒë·∫ßu!**",
        "quote": {},
        "mentions": {}
      },
      "type": "n8n-nodes-zalos-user.zaloSendMessage",
      "typeVersion": 4,
      "position": [
        -400,
        112
      ],
      "id": "247e8738-48e9-4cd3-9abb-191dc44c35de",
      "name": "Help Message",
      "credentials": {
        "zaloApi": {
          "id": "uGkhY1bGC4UxEgv4",
          "name": "zalo-lich"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "image_check",
              "leftValue": "={{ $json.message.data.content.href }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -560,
        -96
      ],
      "id": "d104f8f1-5905-4302-b242-febdf8d91ce4",
      "name": "Validate Image Input"
    },
    {
      "parameters": {
        "threadId": "={{ $('Zalo Message Trigger').item.json.message.threadId }}",
        "type": "={{ $('Zalo Message Trigger').item.json.message.type }}",
        "message": "=‚úÖ **ƒê√É X·ª¨ L√ù TH√ÄNH C√îNG**\n\nüìÑ **Lo·∫°i t√†i li·ªáu:** {{ $json.output.shipping_company ? 'H√≥a ƒë∆°n v·∫≠n chuy·ªÉn' : ($json.output.order_code ? 'ƒê∆°n h√†ng' : 'H√≥a ƒë∆°n/Receipt') }}\n\nüìä **TH√îNG TIN TR√çCH XU·∫§T:**\n{{ $json.output.date_time ? 'üìÖ Ng√†y: ' + $json.output.date_time : '' }}\n{{ $json.output.total_price ? 'üí∞ T·ªïng ti·ªÅn: ' + $json.output.total_price.toString().replace(/(\\d)(?=(\\d{3})+(?!\\d))/g, '$1,') + ' VNƒê' : '' }}\n{{ $json.output.order_code ? 'üì¶ M√£ ƒë∆°n: ' + $json.output.order_code : '' }}\n{{ $json.output.tracking_code ? 'üöö M√£ v·∫≠n ƒë∆°n: ' + $json.output.tracking_code : '' }}\n{{ $json.output.shipping_company ? 'üè¢ ƒê∆°n v·ªã: ' + $json.output.shipping_company : '' }}\n{{ $json.output.content_description ? 'üìù N·ªôi dung: ' + $json.output.content_description : '' }}\n{{ $json.output.quantity ? 'üî¢ S·ªë l∆∞·ª£ng: ' + $json.output.quantity : '' }}\n{{ $json.output.size ? 'üìè Size: ' + $json.output.size : '' }}\n{{ $json.output.weight ? '‚öñÔ∏è Kh·ªëi l∆∞·ª£ng: ' + $json.output.weight : '' }}\n\nüíæ **ƒê√£ l∆∞u v√†o Google Sheets**\n‚è∞ X·ª≠ l√Ω l√∫c: {{ new Date(Date.now() + 7*60*60*1000).toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' }) }}",
        "quote": {},
        "mentions": {}
      },
      "type": "n8n-nodes-zalos-user.zaloSendMessage",
      "typeVersion": 4,
      "position": [
        464,
        64
      ],
      "id": "c26774d9-1030-4fd7-9602-91dd7e4a19f6",
      "name": "Success Response",
      "credentials": {
        "zaloApi": {
          "id": "uGkhY1bGC4UxEgv4",
          "name": "zalo-lich"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1euhy85jNUlAkXdP6kmpI1olZNyOIm61BstUSkaPD1dY",
          "mode": "list",
          "cachedResultName": "FAQ",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1euhy85jNUlAkXdP6kmpI1olZNyOIm61BstUSkaPD1dY/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "FAQ",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1euhy85jNUlAkXdP6kmpI1olZNyOIm61BstUSkaPD1dY/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "S·ªë l∆∞·ª£ng": "={{ $json.output?.quantity || '1' }}",
            "Size": "={{ $json.output?.size || '' }}",
            "ƒê∆°n gi√° ": "={{ $json.output?.total_price || '0' }}",
            "NgaÃÄy": "={{ $json.output.date_time }}",
            "MaÃÉ v√¢Ã£n ƒë∆°n": "={{ $json.output.tracking_code }}",
            "MaÃÉ ƒë∆°n haÃÄng": "={{ $json.output.order_code }}",
            "ƒê∆°n viÃ£ v√¢Ã£n chuy√™Ãân": "={{ $json.output.shipping_company }}",
            "N√¥Ã£i dung": "={{ $json.output.content_description }}",
            "Kh√¥ÃÅi l∆∞∆°Ã£ng": "={{ $json.output.weight }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "NgaÃÄy",
              "displayName": "NgaÃÄy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "MaÃÉ v√¢Ã£n ƒë∆°n",
              "displayName": "MaÃÉ v√¢Ã£n ƒë∆°n",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "MaÃÉ ƒë∆°n haÃÄng",
              "displayName": "MaÃÉ ƒë∆°n haÃÄng",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ƒê∆°n viÃ£ v√¢Ã£n chuy√™Ãân",
              "displayName": "ƒê∆°n viÃ£ v√¢Ã£n chuy√™Ãân",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "N√¥Ã£i dung",
              "displayName": "N√¥Ã£i dung",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "S·ªë l∆∞·ª£ng",
              "displayName": "S·ªë l∆∞·ª£ng",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Size",
              "displayName": "Size",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Kh√¥ÃÅi l∆∞∆°Ã£ng",
              "displayName": "Kh√¥ÃÅi l∆∞∆°Ã£ng",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ƒê∆°n gi√° ",
              "displayName": "ƒê∆°n gi√° ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        640,
        -160
      ],
      "id": "28905df6-3188-4452-adfd-ad552161646a",
      "name": "Save to Google Sheets",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "BBhGOhMwVfBUinTa",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Debug data before sending to Google Sheets\nconst data = $input.first().json;\nconsole.log('Data going to Google Sheets:');\nconsole.log('Full JSON:', JSON.stringify(data, null, 2));\nconsole.log('Output object:', JSON.stringify(data.output, null, 2));\n\n// Test each field mapping\nconst mappings = {\n  'Ng√†y': data.output?.date_time || new Date().toISOString().split('T')[0],\n  'M√£ v·∫≠n ƒë∆°n': data.output?.tracking_code || 'N/A',\n  'M√£ ƒë∆°n h√†ng': data.output?.order_code || 'AUTO_' + Date.now(),\n  'ƒê∆°n v·ªã v·∫≠n chuy·ªÉn': data.output?.shipping_company || 'Kh√¥ng x√°c ƒë·ªãnh',\n  'N·ªôi dung': data.output?.content_description || 'Ch∆∞a c√≥ m√¥ t·∫£',\n  'S·ªë l∆∞·ª£ng': data.output?.quantity || '1',\n  'Size': data.output?.size || '',\n  'Kh·ªëi l∆∞·ª£ng': data.output?.weight || '',\n  'ƒê∆°n gi√° ': data.output?.total_price || '0'\n};\n\nconsole.log('Field mappings:', JSON.stringify(mappings, null, 2));\n\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        464,
        -128
      ],
      "id": "b1c6d84d-6b13-4616-aa56-3d2a418eed3d",
      "name": "Debug Sheets Data"
    },
    {
      "parameters": {
        "jsCode": "// Debug and parse AI response\nconsole.log('Input data:', JSON.stringify($input.first().json, null, 2));\n\n// Try multiple ways to get AI response\nconst inputJson = $input.first().json;\nlet aiResponse = '';\n\n// Check various possible response fields\nif (inputJson.response) {\n  aiResponse = inputJson.response;\n} else if (inputJson.text) {\n  aiResponse = inputJson.text;\n} else if (inputJson.output) {\n  aiResponse = inputJson.output;\n} else if (inputJson.result) {\n  aiResponse = inputJson.result;\n} else {\n  // If no clear response, try the whole object as string\n  aiResponse = JSON.stringify(inputJson);\n}\n\nconsole.log('AI Response:', aiResponse);\n\nlet extractedData;\n\ntry {\n  // First try: parse as JSON directly\n  if (typeof aiResponse === 'object') {\n    extractedData = aiResponse;\n  } else {\n    extractedData = JSON.parse(aiResponse);\n  }\n} catch (error) {\n  console.log('JSON parse error:', error.message);\n  \n  try {\n    // Second try: extract JSON from text using regex\n    const jsonMatch = aiResponse.toString().match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      extractedData = JSON.parse(jsonMatch[0]);\n    } else {\n      throw new Error('No JSON found in response');\n    }\n  } catch (secondError) {\n    console.log('Second parse attempt failed:', secondError.message);\n    \n    // Third try: manual extraction from text\n    const text = aiResponse.toString();\n    extractedData = {\n      date_time: extractValue(text, ['ng√†y', 'date', 'th·ªùi gian']) || new Date().toISOString().split('T')[0],\n      total_price: extractValue(text, ['t·ªïng', 'total', 'gi√°', 'price', 'ti·ªÅn']) || \"0\",\n      tracking_code: extractValue(text, ['tracking', 'm√£ v·∫≠n ƒë∆°n', 'v·∫≠n ƒë∆°n']) || \"\",\n      order_code: extractValue(text, ['order', 'm√£ ƒë∆°n', 'ƒë∆°n h√†ng']) || \"\",\n      shipping_company: extractValue(text, ['company', 'c√¥ng ty', 'giao h√†ng']) || \"\",\n      content_description: extractValue(text, ['content', 'n·ªôi dung', 's·∫£n ph·∫©m']) || \"Kh√¥ng th·ªÉ tr√≠ch xu·∫•t\",\n      quantity: extractValue(text, ['quantity', 's·ªë l∆∞·ª£ng', 'sl']) || \"\",\n      weight: extractValue(text, ['weight', 'kh·ªëi l∆∞·ª£ng', 'kg']) || \"\",\n      size: extractValue(text, ['size', 'k√≠ch th∆∞·ªõc', 'c·ª°']) || \"\"\n    };\n  }\n}\n\n// Helper function to extract values from text\nfunction extractValue(text, keywords) {\n  for (const keyword of keywords) {\n    const regex = new RegExp(keyword + '\\\\s*:?\\\\s*([^\\\\n\\\\r,]+)', 'i');\n    const match = text.match(regex);\n    if (match && match[1]) {\n      return match[1].trim();\n    }\n  }\n  return \"\";\n}\n\n// Ensure all required fields exist with proper defaults\nconst requiredFields = {\n  'date_time': new Date().toISOString().split('T')[0],\n  'total_price': \"0\",\n  'tracking_code': \"\",\n  'order_code': \"\",\n  'shipping_company': \"\",\n  'content_description': \"Kh√¥ng th·ªÉ tr√≠ch xu·∫•t\",\n  'quantity': \"\",\n  'weight': \"\",\n  'size': \"\"\n};\n\n// Fill missing fields\nObject.keys(requiredFields).forEach(field => {\n  if (!extractedData[field] || extractedData[field] === null || extractedData[field] === undefined) {\n    extractedData[field] = requiredFields[field];\n  }\n});\n\n// Clean and format data\nif (extractedData.total_price && typeof extractedData.total_price === 'string') {\n  // Remove currency symbols and non-digits\n  extractedData.total_price = extractedData.total_price.replace(/[^0-9]/g, '') || \"0\";\n}\n\nconsole.log('Final extracted data:', JSON.stringify(extractedData, null, 2));\n\nreturn {\n  json: {\n    output: extractedData,\n    raw_response: aiResponse,\n    debug_input: inputJson\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        288,
        -128
      ],
      "id": "0c742dfb-9184-4abc-ae36-313c94f12bc7",
      "name": "Parse AI Response"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.0-flash",
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -32,
        80
      ],
      "id": "ce530b44-8dde-46d5-867c-35e913678c34",
      "name": "Gemini Pro Model",
      "credentials": {
        "googlePalmApi": {
          "id": "mrxHNSBslzhwOrpt",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "{{ $json.text }}",
        "options": {
          "systemMessage": "You are a professional Vietnamese invoice analyst. Extract information from invoices, receipts, and shipping documents.\n\nYour response must be EXACTLY this JSON format (copy this structure):\n{\n\"date_time\": \"YYYY-MM-DD\",\n\"total_price\": \"numbers_only\",\n\"tracking_code\": \"text_or_empty_string\",\n\"order_code\": \"text_or_empty_string\",\n\"shipping_company\": \"text_or_empty_string\",\n\"content_description\": \"text_or_empty_string\",\n\"quantity\": \"text_or_empty_string\",\n\"weight\": \"text_or_empty_string\",\n\"size\": \"text_or_empty_string\"\n}\n\nRules:\n- Extract date and convert to YYYY-MM-DD format\n- Extract total amount, remove VNƒê/ƒë symbols, keep numbers only\n- Find tracking/shipping codes\n- Find order/invoice numbers\n- Identify company/platform names\n- Extract product descriptions\n- Find quantity information\n- Extract weight (kg, g)\n- Find size info (S,M,L,XL)\n- Use empty string \"\" for missing fields\n- Return ONLY the JSON, no other text"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        16,
        -128
      ],
      "id": "a8f56b80-39d6-45cd-9af9-4397478701f5",
      "name": "Smart Invoice AI"
    },
    {
      "parameters": {
        "options": {
          "language": "vie+eng"
        }
      },
      "type": "n8n-nodes-tesseractjs.tesseractNode",
      "typeVersion": 1,
      "position": [
        -176,
        -128
      ],
      "id": "a5a5e665-751b-4622-85d9-79541db1048e",
      "name": "Tesseract OCR"
    },
    {
      "parameters": {
        "url": "={{ $json.message.data.content.href }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -368,
        -128
      ],
      "id": "c247bd41-9e83-4e86-90de-ca98901211ad",
      "name": "HTTP Request"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-zalos-user.zaloMessageTrigger",
      "typeVersion": 1,
      "position": [
        -752,
        -80
      ],
      "id": "f5405450-cb04-44d4-831c-7dfbb0b3de08",
      "name": "Zalo Message Trigger",
      "webhookId": "845b53ea-fb24-4ff8-ba97-0daf4e8f1901",
      "credentials": {
        "zaloApi": {
          "id": "uGkhY1bGC4UxEgv4",
          "name": "zalo-lich"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Validate Image Input": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Help Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Sheets Data": {
      "main": [
        [
          {
            "node": "Save to Google Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse AI Response": {
      "main": [
        [
          {
            "node": "Success Response",
            "type": "main",
            "index": 0
          },
          {
            "node": "Debug Sheets Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Pro Model": {
      "ai_languageModel": [
        [
          {
            "node": "Smart Invoice AI",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Smart Invoice AI": {
      "main": [
        [
          {
            "node": "Parse AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tesseract OCR": {
      "main": [
        [
          {
            "node": "Smart Invoice AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Tesseract OCR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Zalo Message Trigger": {
      "main": [
        [
          {
            "node": "Validate Image Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "13c15644-cb4a-4b86-a88f-bd2899e529d8",
  "meta": {
    "instanceId": "2b0f722d9af2cb75e39eae8097a3393439f43cd078decf672b020f10d7e99f97"
  },
  "id": "HQIswIX6B2gMYyJd",
  "tags": []
}